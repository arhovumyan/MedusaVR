import{j as r}from"./ui-vendor-yJ52fMSG.js";import{r as i,a as B}from"./react-vendor-CgzYKCvO.js";import{b as H}from"./query-vendor-8KRGqY0G.js";import{L as Y}from"./routing-DoJeAdmJ.js";import{u as Z,t as ee,l as te,b as M,B as I}from"./index-DDdEVrIf.js";import{ar as U,H as re,M as se}from"./icons-CPY5GJO9.js";function ae(e){return/res\.cloudinary\.com\//.test(e)&&/\/image\/upload\//.test(e)}function oe(e,o){return e.replace(/(\/image\/upload\/)(?!v\d+\/)/,`$1${o}/`)}function z(e,o){const l="/fallback.jpg",a=e||l;if(!a||typeof a!="string")return l;if(!ae(a))return a;try{const u=`c_fill,f_auto,q_auto:eco,w_${Math.max(1,Math.floor(o))}`,c=oe(a,u);return!c||typeof c!="string"?a:c}catch(u){return console.warn("Error optimizing image URL:",a,u),a}}function ne(e,o){if(!e)return;const l=o.filter(a=>a>0&&Number.isInteger(a));if(l.length!==0)try{const a=l.map(u=>{const c=z(e,u);return c&&c!==e||c===e?`${c} ${u}w`:null}).filter(Boolean);return a.length>0?a.join(", "):void 0}catch(a){console.warn("Error building srcset for URL:",e,a);return}}const ie=i.memo(({char:e,isCharacterFavorite:o,onFavoriteClick:l,isBlurred:a,shouldBlurNSFW:u,disableHoverScale:c=!1,fetchPriority:h="auto"})=>{const[v,x]=i.useState(!1),j=i.useRef(null),[p,y]=i.useState(320),b=i.useRef(null);return i.useEffect(()=>{if(!j.current)return;const d=j.current,n=()=>y(d.clientWidth||320);n();const C=new ResizeObserver(n);return C.observe(d),()=>C.disconnect()},[]),i.useEffect(()=>{const d=z(e.avatar,Math.min(512,p*1.5)),n=new Image;n.onload=()=>x(!0),n.onerror=()=>x(!0),n.src=d,b.current=n},[e.avatar,p]),r.jsx(Y,{to:`/characters/${e.id}`,className:"block",onClick:()=>console.log(`Navigating to character ${e.id}`),children:r.jsxs("div",{ref:j,className:`character-card responsive-character-card relative overflow-hidden rounded-lg shadow-lg transition-transform duration-300 ease-in-out group ${c?"":"hover:scale-105"}`,children:[!v&&r.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-zinc-800 via-zinc-700 to-zinc-800 animate-pulse"}),r.jsx("img",{src:z(e.avatar,Math.min(512,p*1.5)),alt:e.name,className:`absolute inset-0 w-full h-full object-cover object-center transition-opacity duration-500 ease-out ${v?"opacity-100":"opacity-0"}`,style:{filter:u(e.nsfw||!1)?"blur(20px)":void 0,opacity:u(e.nsfw||!1)?.6:void 0},loading:h==="high"?"eager":"lazy",decoding:"async",fetchPriority:h,sizes:"(max-width: 640px) 50vw, (max-width: 1024px) 25vw, 300px",srcSet:ne(e.avatar,[240,360,480,640])||void 0,onLoad:()=>x(!0),onError:d=>{const n=d.target;n.src="/fallback.jpg",x(!0)}}),r.jsx("button",{onClick:d=>l(d,e),className:"absolute top-2 right-2 w-8 h-8 rounded-full bg-black/60 backdrop-blur-sm border border-white/20 flex items-center justify-center transition-all duration-200 hover:scale-110 z-10 opacity-100",children:r.jsx(re,{className:`w-4 h-4 transition-colors ${o?"text-red-500 fill-red-500":"text-white hover:text-red-400"}`})}),r.jsxs("div",{className:"absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 via-black/60 to-transparent p-3 text-white",children:[r.jsx("h3",{className:"text-base font-semibold mb-2 truncate",children:e.name}),r.jsx("p",{className:"text-xs mb-3 line-clamp-2 leading-tight opacity-90",children:e.description}),r.jsx("div",{className:"flex items-center justify-between",children:r.jsxs("div",{className:"flex items-center",children:[r.jsx(se,{className:"w-4 h-4 text-white/80 mr-1"}),r.jsx("span",{className:"text-sm font-medium",children:e.totalWords?e.totalWords>1e3?`${(e.totalWords/1e3).toFixed(1)}K`:e.totalWords.toLocaleString():e.chatCount?e.chatCount>1e3?`${(e.chatCount/1e3).toFixed(1)}K`:e.chatCount.toLocaleString():"0"})]})})]})]})},e.id)}),ce=i.memo(()=>r.jsx("div",{className:"character-card responsive-character-card relative overflow-hidden rounded-lg shadow-lg",children:r.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-zinc-800 via-zinc-700 to-zinc-800 animate-pulse",children:r.jsxs("div",{className:"absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 via-black/60 to-transparent p-3",children:[r.jsx("div",{className:"h-4 bg-zinc-600 rounded mb-2 animate-pulse"}),r.jsx("div",{className:"h-3 bg-zinc-700 rounded mb-2 animate-pulse"}),r.jsx("div",{className:"h-3 bg-zinc-700 rounded w-3/4 animate-pulse"})]})})})),le=({mode:e="all",limit:o,randomize:l=!1,onLoadMore:a,showLoadMoreButton:u=!1,prioritizeUserPreferences:c=!1,singleRowOnly:h=!1,externalCharacters:v,externalLoading:x=!1,externalError:j=null,pageSize:p=40})=>{const{user:y}=Z(),[b,d]=i.useState(0),[n,C]=i.useState(!0),[_,S]=i.useState([]),{data:N,error:de}=H({queryKey:["word-stats-all"],queryFn:async()=>{try{const s=await(await M("GET","/api/word-stats/all-characters",void 0,{},"low")).json();return s.success?s.wordStats:{}}catch(t){return console.warn("⚠️ Word stats fetch failed:",t),{}}},staleTime:3e5,refetchOnWindowFocus:!1,retry:(t,s)=>s?.status===408||s?.status===504?!1:t<2,retryDelay:5e3}),{data:k,error:K,isLoading:D,refetch:L}=H({queryKey:["characters",e,o,p,b],queryFn:async()=>{const t=new URLSearchParams;e!=="all"&&t.append("mode",e),e==="discover"?(t.append("page",b.toString()),t.append("pageSize",p.toString())):(l&&t.append("randomize","true"),o&&t.append("limit",o.toString()));const s=`/api/characters${t.toString()?"?"+t.toString():""}`;console.log(`🔍 Fetching ${e} characters:`,s);const m=await M("GET",s,void 0,{},"low"),f=m.headers.get("X-Pagination-Reset")==="true",g=m.headers.get("X-Has-More")==="true";f&&(console.log("🔄 Pagination reset detected, starting over"),d(0),S([])),C(g);const w=await m.json();return e==="discover"&&!f?S(A=>{const J=new Set(A.map(F=>F.id)),V=w.filter(F=>!J.has(F.id));return[...A,...V]}):e==="discover"&&f&&S(w),w},staleTime:l||e==="discover"?0:6e5,refetchOnWindowFocus:!1,refetchOnReconnect:!1,retry:(t,s)=>s?.isRateLimit?!1:t<2,enabled:!v}),W=v||(e==="discover"?_:k)||[],$=v?x:D,R=v?j:K,{isFavorite:G,toggleFavorite:P}=ee(),{isBlurred:O,shouldBlurNSFW:X}=te(),T=i.useCallback(()=>{e==="discover"&&n?d(t=>t+1):(e==="discover"&&!n&&(console.log("🔄 No more characters, resetting pagination"),d(0),S([])),L()),a&&a()},[e,n,a,L]),E=B.useCallback((t,s)=>{if(!s||s.length===0)return 0;let m=0;return t.tagNames&&Array.isArray(t.tagNames)&&(t.tagNames.forEach(f=>{s.includes(f)&&(m+=1)}),i.useEffect(()=>{if(e!=="discover"||!k||k.length===0||!n)return;const f=b+1,g=new URLSearchParams;g.append("mode","discover"),g.append("page",String(f)),g.append("pageSize",String(p));const w=`/api/characters?${g.toString()}`;M("GET",w,void 0,{},"low").catch(()=>{})},[e,k,n,b,p])),m},[]),q=B.useMemo(()=>{if(!W)return[];let t=[...W];if(N&&(t=t.map(s=>({...s,totalWords:N[s.id]?.totalWords||0,userWords:N[s.id]?.userWords||0,characterWords:N[s.id]?.characterWords||0}))),e!=="featured"&&c&&y?.preferences?.selectedTags){const s=y.preferences.selectedTags||[];t=t.sort((m,f)=>{const g=E(m,s);return E(f,s)-g})}else l&&e!=="discover"&&(t=t.sort(()=>Math.random()-.5));return o&&o>0&&e!=="discover"&&(t=t.slice(0,o)),t},[W,l,o,c,y?.preferences?.selectedTags,E,e,N]),Q=i.useCallback((t,s)=>{t.preventDefault(),t.stopPropagation(),P(s)},[P]);return R?r.jsxs("div",{className:"text-center p-4",children:[r.jsx("div",{className:"text-red-400 mb-2",children:"Failed to load characters"}),r.jsx("div",{className:"text-sm text-gray-400",children:R?.isRateLimit?"Loading... please wait a moment":R.message||"Please try refreshing the page"})]}):$?r.jsx("div",{className:"px-0 w-full",children:r.jsx("div",{className:"card-container responsive-character-grid w-full",children:Array.from({length:h?6:o||12}).map((t,s)=>r.jsx(ce,{},s))})}):r.jsxs("div",{className:"px-0 w-full",children:[r.jsx("div",{className:h?"flex gap-4 overflow-x-auto scrollbar-hide pb-2 overscroll-x-contain":"card-container responsive-character-grid w-full",style:h?{touchAction:"pan-x pan-y"}:void 0,children:q.map((t,s)=>{const m=G(t.id),f=s<6?"high":"auto";return r.jsx("div",{className:h?"flex-shrink-0":"",children:r.jsx(ie,{char:t,isCharacterFavorite:m,onFavoriteClick:Q,isBlurred:O,shouldBlurNSFW:X,disableHoverScale:h,fetchPriority:f})},t.id)})}),u&&r.jsx("div",{className:"mt-8 text-center",children:e==="discover"&&!n?r.jsxs(I,{onClick:T,className:"bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 text-white font-semibold px-8 py-3 rounded-lg shadow-lg shadow-blue-500/25 transition-all duration-300 hover:scale-105",children:[r.jsx(U,{className:"w-5 h-5 mr-2"}),"Start Over - Discover More Characters"]}):q.length>0?r.jsxs(I,{onClick:T,disabled:$,className:"bg-gradient-to-r from-orange-500 to-amber-500 hover:from-orange-600 hover:to-amber-600 text-white font-semibold px-8 py-3 rounded-lg shadow-lg shadow-orange-500/25 transition-all duration-300 hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed",children:[r.jsx(U,{className:`w-5 h-5 mr-2 ${$?"animate-spin":""}`}),e==="discover"?"Load More Characters":"Refresh Characters"]}):null})]})},ve=i.memo(le);export{ve as C};
