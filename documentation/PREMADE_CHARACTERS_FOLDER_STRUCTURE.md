# Premade Characters Folder Structure Implementation

## Overview

This update implements a new folder structure for image generation to differentiate between:
1. **Character Creation Images**: Images generated during character creation (saved under character creator's folder)
2. **Premade Character Images**: Images generated by users using existing characters (saved under current user's folder)

## New Folder Structure

### Before (All images in character creator's folder):
```
{character_creator_username}/characters/{character_name}/images/
```

### After (Separated by usage):

#### Character Creation (unchanged):
```
{character_creator_username}/characters/{character_name}/images/
```

#### Using Existing Characters (new):
```
{current_user_username}/premade_characters/{character_name}/images/
```

## Changes Made

### 1. CloudinaryFolderService.ts

#### New Methods Added:
- `getPremadeCharacterFolderPaths(username, characterName)`: Creates folder structure for premade characters
- `uploadToPremadeCharacterFolder(...)`: Uploads files to premade character folder structure

#### Folder Structure:
```typescript
// Original character folders (for character creators)
{username}/characters/{character-name}/
├── avatar/
├── images/
├── variations/
├── embeddings/
└── generations/

// New premade character folders (for users using existing characters)
{username}/premade_characters/{character-name}/
├── avatar/
├── images/
├── variations/
├── embeddings/
└── generations/
```

### 2. EmbeddingBasedImageGenerationService.ts

#### Interface Updated:
```typescript
export interface EmbeddingBasedGenerationOptions {
  // ... existing options
  currentUserId?: string; // New: The user generating the image
}
```

#### Logic Changes:
- `generateSingleImage()`: Now accepts `currentUserId` parameter
- **Folder Selection Logic**:
  - If `currentUserId` is provided → Use `uploadToPremadeCharacterFolder()`
  - If `currentUserId` is not provided → Use `uploadToCharacterFolder()` (backward compatibility)
- `getNextImageNumber()`: Updated to support both folder structures
- `getCharacterImages()`: Now searches in premade_characters folder

### 3. AsyncImageGenerationService.ts

#### Updated Calls:
- Passes `job.userId` as `currentUserId` to `generateImageWithEmbedding()`
- This ensures images are saved under the current user's premade_characters folder

### 4. Routes (character.ts)

#### Updated API Endpoint:
- `/characters/:id/generate-image` now passes current user ID
- Images generated via API are saved in user's premade_characters folder

## Usage Scenarios

### Scenario 1: Character Creation
```javascript
// During character creation (no currentUserId passed)
await embeddingService.generateImageWithEmbedding({
  characterId: "123",
  prompt: "portrait",
  // currentUserId: undefined (not passed)
});
// → Saves to: creator_username/characters/character-name/images/
```

### Scenario 2: Using Existing Character (API)
```javascript
// User generates image from existing character
await embeddingService.generateImageWithEmbedding({
  characterId: "123",
  prompt: "happy mood",
  currentUserId: "current_user_id"
});
// → Saves to: current_user_username/premade_characters/character-name/images/
```

### Scenario 3: Using Existing Character (Async Service)
```javascript
// Via AsyncImageGenerationService
const job = await asyncService.startGeneration(userId, {
  characterId: "123",
  prompt: "sad mood"
});
// → Automatically uses userId as currentUserId
// → Saves to: user_username/premade_characters/character-name/images/
```

## Backward Compatibility

### Maintained Compatibility:
- ✅ Existing character creation workflows unchanged
- ✅ Old images remain accessible in original locations
- ✅ If `currentUserId` is not provided, falls back to character creator folder
- ✅ All existing API contracts maintained

### Migration Notes:
- No migration required for existing data
- New images will use the new folder structure automatically
- Users can still access previously generated images

## File Organization Benefits

### For Users:
- **Clear Separation**: Own generated images vs. character creator's images
- **Personal Library**: All user-generated content in one place
- **Privacy**: Users can only see their own generated images
- **Organization**: Easier to find and manage personal content

### For System:
- **Scalability**: Better distribution of files across user folders
- **Access Control**: Natural separation by user ownership
- **Storage Management**: Easier to track usage per user
- **Cleanup**: Easier to remove user's content when needed

## Example Folder Structure

```
cloudinary_root/
├── alice/
│   ├── characters/                    # Alice's created characters
│   │   └── alice-character/
│   │       └── images/               # Images from Alice's character creation
│   └── premade_characters/           # Characters Alice used from others
│       ├── bob-character/
│       │   └── images/              # Images Alice generated using Bob's character
│       └── charlie-character/
│           └── images/              # Images Alice generated using Charlie's character
├── bob/
│   ├── characters/                   # Bob's created characters
│   │   └── bob-character/
│   │       └── images/              # Images from Bob's character creation
│   └── premade_characters/          # Characters Bob used from others
│       └── alice-character/
│           └── images/              # Images Bob generated using Alice's character
└── charlie/
    ├── characters/                  # Charlie's created characters
    │   └── charlie-character/
    │       └── images/             # Images from Charlie's character creation
    └── premade_characters/         # Characters Charlie used from others
        ├── alice-character/
        │   └── images/            # Images Charlie generated using Alice's character
        └── bob-character/
            └── images/            # Images Charlie generated using Bob's character
```

## Testing

### Test Cases:
1. **Character Creation**: Verify images save to `characters/` folder
2. **API Generation**: Verify images save to `premade_characters/` folder
3. **Async Generation**: Verify images save to `premade_characters/` folder
4. **Image Retrieval**: Verify `getCharacterImages()` finds correct images
5. **Backward Compatibility**: Verify old workflows still work

### Log Messages to Watch:
```
📂 Using current user's folder: username
📂 Uploaded to premade character folder: username/premade_characters/character-name/images
🔍 Searching Cloudinary folder: username/premade_characters/character-name/images
```

This implementation provides clear separation of content ownership while maintaining full backward compatibility.
