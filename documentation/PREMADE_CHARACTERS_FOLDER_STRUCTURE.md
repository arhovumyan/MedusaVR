# Premade Characters Folder Structure Implementation

## Overview

This update implements a new folder structure for image generation to differentiate between:
1. **Character Creation Images**: Images generated during character creation (saved under character creator's folder)
2. **Premade Character Images**: Images generated by users using existing characters (saved under current user's folder)

## New Folder Structure

### Before (All images in character creator's folder):
```
{character_creator_username}/characters/{character_name}/images/
```

### After (Separated by usage):

#### Character Creation (unchanged):
```
{character_creator_username}/characters/{character_name}/images/
```

#### Using Existing Characters (new):
```
{current_user_username}/premade_characters/{character_name}/images/
```

## Changes Made

### 1. CloudinaryFolderService.ts

#### New Methods Added:
- `getPremadeCharacterFolderPaths(username, characterName)`: Creates folder structure for premade characters
- `uploadToPremadeCharacterFolder(...)`: Uploads files to premade character folder structure

#### Folder Structure:
```typescript
// Original character folders (for character creators)
{username}/characters/{character-name}/
â”œâ”€â”€ avatar/
â”œâ”€â”€ images/
â”œâ”€â”€ variations/
â”œâ”€â”€ embeddings/
â””â”€â”€ generations/

// New premade character folders (for users using existing characters)
{username}/premade_characters/{character-name}/
â”œâ”€â”€ avatar/
â”œâ”€â”€ images/
â”œâ”€â”€ variations/
â”œâ”€â”€ embeddings/
â””â”€â”€ generations/
```

### 2. EmbeddingBasedImageGenerationService.ts

#### Interface Updated:
```typescript
export interface EmbeddingBasedGenerationOptions {
  // ... existing options
  currentUserId?: string; // New: The user generating the image
}
```

#### Logic Changes:
- `generateSingleImage()`: Now accepts `currentUserId` parameter
- **Folder Selection Logic**:
  - If `currentUserId` is provided â†’ Use `uploadToPremadeCharacterFolder()`
  - If `currentUserId` is not provided â†’ Use `uploadToCharacterFolder()` (backward compatibility)
- `getNextImageNumber()`: Updated to support both folder structures
- `getCharacterImages()`: Now searches in premade_characters folder

### 3. AsyncImageGenerationService.ts

#### Updated Calls:
- Passes `job.userId` as `currentUserId` to `generateImageWithEmbedding()`
- This ensures images are saved under the current user's premade_characters folder

### 4. Routes (character.ts)

#### Updated API Endpoint:
- `/characters/:id/generate-image` now passes current user ID
- Images generated via API are saved in user's premade_characters folder

## Usage Scenarios

### Scenario 1: Character Creation
```javascript
// During character creation (no currentUserId passed)
await embeddingService.generateImageWithEmbedding({
  characterId: "123",
  prompt: "portrait",
  // currentUserId: undefined (not passed)
});
// â†’ Saves to: creator_username/characters/character-name/images/
```

### Scenario 2: Using Existing Character (API)
```javascript
// User generates image from existing character
await embeddingService.generateImageWithEmbedding({
  characterId: "123",
  prompt: "happy mood",
  currentUserId: "current_user_id"
});
// â†’ Saves to: current_user_username/premade_characters/character-name/images/
```

### Scenario 3: Using Existing Character (Async Service)
```javascript
// Via AsyncImageGenerationService
const job = await asyncService.startGeneration(userId, {
  characterId: "123",
  prompt: "sad mood"
});
// â†’ Automatically uses userId as currentUserId
// â†’ Saves to: user_username/premade_characters/character-name/images/
```

## Backward Compatibility

### Maintained Compatibility:
- âœ… Existing character creation workflows unchanged
- âœ… Old images remain accessible in original locations
- âœ… If `currentUserId` is not provided, falls back to character creator folder
- âœ… All existing API contracts maintained

### Migration Notes:
- No migration required for existing data
- New images will use the new folder structure automatically
- Users can still access previously generated images

## File Organization Benefits

### For Users:
- **Clear Separation**: Own generated images vs. character creator's images
- **Personal Library**: All user-generated content in one place
- **Privacy**: Users can only see their own generated images
- **Organization**: Easier to find and manage personal content

### For System:
- **Scalability**: Better distribution of files across user folders
- **Access Control**: Natural separation by user ownership
- **Storage Management**: Easier to track usage per user
- **Cleanup**: Easier to remove user's content when needed

## Example Folder Structure

```
cloudinary_root/
â”œâ”€â”€ alice/
â”‚   â”œâ”€â”€ characters/                    # Alice's created characters
â”‚   â”‚   â””â”€â”€ alice-character/
â”‚   â”‚       â””â”€â”€ images/               # Images from Alice's character creation
â”‚   â””â”€â”€ premade_characters/           # Characters Alice used from others
â”‚       â”œâ”€â”€ bob-character/
â”‚       â”‚   â””â”€â”€ images/              # Images Alice generated using Bob's character
â”‚       â””â”€â”€ charlie-character/
â”‚           â””â”€â”€ images/              # Images Alice generated using Charlie's character
â”œâ”€â”€ bob/
â”‚   â”œâ”€â”€ characters/                   # Bob's created characters
â”‚   â”‚   â””â”€â”€ bob-character/
â”‚   â”‚       â””â”€â”€ images/              # Images from Bob's character creation
â”‚   â””â”€â”€ premade_characters/          # Characters Bob used from others
â”‚       â””â”€â”€ alice-character/
â”‚           â””â”€â”€ images/              # Images Bob generated using Alice's character
â””â”€â”€ charlie/
    â”œâ”€â”€ characters/                  # Charlie's created characters
    â”‚   â””â”€â”€ charlie-character/
    â”‚       â””â”€â”€ images/             # Images from Charlie's character creation
    â””â”€â”€ premade_characters/         # Characters Charlie used from others
        â”œâ”€â”€ alice-character/
        â”‚   â””â”€â”€ images/            # Images Charlie generated using Alice's character
        â””â”€â”€ bob-character/
            â””â”€â”€ images/            # Images Charlie generated using Bob's character
```

## Testing

### Test Cases:
1. **Character Creation**: Verify images save to `characters/` folder
2. **API Generation**: Verify images save to `premade_characters/` folder
3. **Async Generation**: Verify images save to `premade_characters/` folder
4. **Image Retrieval**: Verify `getCharacterImages()` finds correct images
5. **Backward Compatibility**: Verify old workflows still work

### Log Messages to Watch:
```
ğŸ“‚ Using current user's folder: username
ğŸ“‚ Uploaded to premade character folder: username/premade_characters/character-name/images
ğŸ” Searching Cloudinary folder: username/premade_characters/character-name/images
```

This implementation provides clear separation of content ownership while maintaining full backward compatibility.
